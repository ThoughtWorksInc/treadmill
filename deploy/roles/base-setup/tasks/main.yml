---
- name: Upgrade all packages
  yum:
    name: '*'
    state: latest

- name: Get instance metadata from AWS API
  uri:
    url: http://169.254.169.254/latest/meta-data/instance-id
    return_content: yes
  register: local_instance_id

- name: Set hostname
  hostname:
    name: "{{item.tags.Name}}{{item.tags.instance_number}}.{{domain}}"
  with_items: 
    - "{{instance_facts_master.instances}}"
    - "{{instance_facts_node_server.instances}}"
    - "{{instance_facts_freeipa_server.instances}}"
  when: item.id == local_instance_id.content
